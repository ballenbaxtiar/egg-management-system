<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>سەرژمێری هێلکە - داشبۆرد</title>

  <link href="assets/img/favicon.png" rel="icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
  <style>
    .filter {
      position: absolute;
      right: 20px;
      top: 15px;
      z-index: 10;
    }

    .filter .form-select {
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 5px 30px 5px 10px;
      font-size: 14px;
      color: #012970;
      background-color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter .form-select:hover {
      border-color: #4154f1;
    }

    .filter .form-select:focus {
      border-color: #4154f1;
      box-shadow: 0 0 0 0.2rem rgba(65, 84, 241, 0.25);
    }

    /* Receipt Styles */
    #reportContainer {
      position: fixed;
      left: -9999px;
      top: 0;
      width: 794px;
      padding: 40px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Vazirmatn', sans-serif;
      direction: rtl;
      min-height: 100vh;
    }

    .watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 120px;
      color: rgba(102, 126, 234, 0.05);
      font-weight: 900;
      white-space: nowrap;
      z-index: 0;
      pointer-events: none;
    }

    .receipt-header {
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      border-radius: 15px 15px 0 0;
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .receipt-header h1 {
      margin: 0;
      font-size: 36px;
      font-weight: 800;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .receipt-header h2 {
      margin: 10px 0 0 0;
      font-size: 18px;
      font-weight: 400;
      opacity: 0.95;
    }

    .receipt-body {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 1;
    }

    .info-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
      padding: 20px;
      border-radius: 12px;
      border-right: 4px solid #667eea;
    }

    .info-card h3 {
      color: #667eea;
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    }

    .info-card p {
      margin: 8px 0;
      font-size: 13px;
      color: #333;
    }

    .info-card strong {
      color: #667eea;
      font-weight: 600;
    }

    .summary-section {
      margin: 30px 0;
    }

    .summary-title {
      color: #667eea;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border-radius: 10px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .summary-card h4 {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 10px 0;
      opacity: 0.95;
    }

    .summary-card .value {
      font-size: 28px;
      font-weight: 800;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 30px 0;
    }

    .stat-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .stat-box h4 {
      color: #667eea;
      font-size: 14px;
      margin: 0 0 10px 0;
    }

    .stat-box .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #012970;
      margin: 5px 0;
    }

    .stat-box .stat-label {
      font-size: 12px;
      color: #666;
    }

    .table-section {
      margin-top: 30px;
    }

    .table-title {
      color: #667eea;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
    }

    .receipt-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      border-radius: 10px;
      overflow: hidden;
    }

    .receipt-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .receipt-table thead th {
      padding: 15px 12px;
      font-weight: 700;
      font-size: 13px;
      text-align: center;
      border: none;
    }

    .receipt-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .receipt-table tbody td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
      font-size: 12px;
      color: #333;
    }

    .receipt-footer {
      margin-top: 30px;
      text-align: center;
      color: #666;
      position: relative;
      z-index: 1;
    }

    .footer-line {
      height: 3px;
      background: linear-gradient(90deg, transparent 0%, #667eea 50%, transparent 100%);
      margin-bottom: 15px;
    }
  </style>
</head>

<body>
  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">
    <div class="d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center">
        <span class="d-none d-lg-block">سەرژمێری هێلکە</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div>

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">
        <li class="nav-item dropdown pe-3">
          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle"></i>
            <span class="d-none d-md-block dropdown-toggle ps-2" id="userFirstname"></span>
          </a>

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
              <h6 id="userFullname"></h6>
              <span id="userType"></span>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <a class="dropdown-item d-flex align-items-center" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-left"></i>
                <span>چوونە دەرەوە</span>
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
      <li class="nav-item">
        <a class="nav-link" href="index.html">
          <i class="bi bi-grid"></i>
          <span>داشبۆرد</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#components-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-house-door"></i><span>فارمەکان</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="components-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
          <li><a href="farm1.html"><i class="bi bi-circle"></i><span>فارمی یەکەم</span></a></li>
          <li><a href="farm2.html"><i class="bi bi-circle"></i><span>فارمی دووەم</span></a></li>
          <li><a href="farm3.html"><i class="bi bi-circle"></i><span>فارمی سێیەم</span></a></li>
          <li><a href="farm4.html"><i class="bi bi-circle"></i><span>فارمی چوارەم</span></a></li>
        </ul>
      </li>

      <li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#forms-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-people"></i><span>بەکارهێنەرەکان</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="forms-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
          <li><a href="admin.html"><i class="bi bi-circle"></i><span>ئەدمین</span></a></li>
          <li><a href="watcher.html"><i class="bi bi-circle"></i><span>لاوەکی</span></a></li>
        </ul>
      </li>

      <li class="nav-heading">بەشەکان</li>

      <li class="nav-item">
        <a class="nav-link collapsed" href="calculation.html">
          <i class="bi bi-calculator"></i>
          <span>سەرژمێری</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link collapsed" onclick="alert('ئەم خزمەتگوزاریە جارێ بەردەست نییە!');">
          <i class="bi bi-gear"></i>
          <span>ڕێکخستن</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link collapsed" href="#" onclick="logout()">
          <i class="bi bi-box-arrow-left"></i>
          <span>چوونە دەرەوە</span>
        </a>
      </li>
    </ul>
  </aside>

  <main id="main" class="main">
    <div class="pagetitle">
      <h1>بەخێربێیت <span id="welcomeName"></span></h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">داشبۆرد</a></li>
          <li class="breadcrumb-item active">کورتەی گشتی</li>
        </ol>
      </nav>
    </div>

    <!-- Time Period Filter -->
    <section class="section dashboard">
      <div class="row" dir="rtl">
        <div class="col-xxl-12 col-md-12">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">کورتەی گشتی <span id="periodLabel">| ئەمڕۆ</span></h5>
                <select class="form-select form-select-sm" onchange="changeTimePeriod(this.value)"
                  style="width: auto; min-width: 150px;">
                  <option value="today">ئەمڕۆ</option>
                  <option value="week">ئەم حەفتەیە</option>
                  <option value="month">ئەم مانگە</option>
                  <option value="all">هەموو</option>
                </select>
              </div>
              <div class="card-body">
                <div class="row" dir="rtl">
                  <div class="col-xxl-4 col-md-6">
                    <div class="card info-card sales-card">
                      <div class="card-body">
                        <h5 class="card-title">کۆی هێلکە <span>| <span id="eggsLabel">ئەمڕۆ</span></span></h5>
                        <div class="d-flex align-items-center">
                          <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-egg"></i>
                          </div>
                          <div class="ps-3">
                            <h6 id="totalEggs">0</h6>
                            <span class="text-success small pt-1 fw-bold" id="eggsPercentage">0%</span>
                            <span class="text-muted small pt-2 ps-1">لە پێشتر</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Total Flats -->
                  <div class="col-xxl-4 col-md-6">
                    <div class="card info-card revenue-card">
                      <div class="card-body">
                        <h5 class="card-title">کۆی تەبەق <span>| <span id="flatsLabel">ئەمڕۆ</span></span></h5>
                        <div class="d-flex align-items-center">
                          <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-stack"></i>
                          </div>
                          <div class="ps-3">
                            <h6 id="totalFlats">0</h6>
                            <span class="text-success small pt-1 fw-bold" id="flatsPercentage">0%</span>
                            <span class="text-muted small pt-2 ps-1">لە پێشتر</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Total Packets -->
                  <div class="col-xxl-4 col-md-6">
                    <div class="card info-card customers-card">
                      <div class="card-body">
                        <h5 class="card-title">کۆی کارتۆن <span>| <span id="packetsLabel">ئەمڕۆ</span></span></h5>
                        <div class="d-flex align-items-center">
                          <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-box"></i>
                          </div>
                          <div class="ps-3">
                            <h6 id="totalPackets">0</h6>
                            <span class="text-success small pt-1 fw-bold" id="packetsPercentage">0%</span>
                            <span class="text-muted small pt-2 ps-1">لە پێشتر</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>


        <!-- Daily, Weekly, Monthly Comparison -->
        <div class="row" dir="rtl">
          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">بەراوردی بەرهەمهێنان <span>| ڕۆژانە، حەفتانە، مانگانە</span></h5>

                <div class="row">
                  <!-- Daily Production -->
                  <div class="col-md-4">
                    <div class="card bg-primary-light">
                      <div class="card-body">
                        <h6 class="card-title text-primary"><i class="bi bi-calendar-day"></i> بەرهەمی ڕۆژانە</h6>
                        <div class="row">
                          <div class="col-6">
                            <p class="mb-1"><strong>ئەمڕۆ:</strong></p>
                            <h4 class="text-primary" id="dailyToday">0</h4>
                          </div>
                          <div class="col-6">
                            <p class="mb-1"><strong>دوێنێ:</strong></p>
                            <h4 class="text-muted" id="dailyYesterday">0</h4>
                          </div>
                        </div>
                        <div class="mt-2">
                          <span class="badge bg-primary" id="dailyChange">0%</span>
                          <small class="text-muted"> جیاوازی</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Weekly Production -->
                  <div class="col-md-4">
                    <div class="card bg-success-light">
                      <div class="card-body">
                        <h6 class="card-title text-success"><i class="bi bi-calendar-week"></i> بەرهەمی حەفتانە</h6>
                        <div class="row">
                          <div class="col-6">
                            <p class="mb-1"><strong>ئەم حەفتە:</strong></p>
                            <h4 class="text-success" id="weeklyThis">0</h4>
                          </div>
                          <div class="col-6">
                            <p class="mb-1"><strong>حەفتەی پێشوو:</strong></p>
                            <h4 class="text-muted" id="weeklyLast">0</h4>
                          </div>
                        </div>
                        <div class="mt-2">
                          <span class="badge bg-success" id="weeklyChange">0%</span>
                          <small class="text-muted"> جیاوازی</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Monthly Production -->
                  <div class="col-md-4">
                    <div class="card bg-warning-light">
                      <div class="card-body">
                        <h6 class="card-title text-warning"><i class="bi bi-calendar-month"></i> بەرهەمی مانگانە</h6>
                        <div class="row">
                          <div class="col-6">
                            <p class="mb-1"><strong>ئەم مانگە:</strong></p>
                            <h4 class="text-warning" id="monthlyThis">0</h4>
                          </div>
                          <div class="col-6">
                            <p class="mb-1"><strong>مانگی پێشوو:</strong></p>
                            <h4 class="text-muted" id="monthlyLast">0</h4>
                          </div>
                        </div>
                        <div class="mt-2">
                          <span class="badge bg-warning" id="monthlyChange">0%</span>
                          <small class="text-muted"> جیاوازی</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Farm Performance Comparison -->
        <div class="row" dir="rtl">
          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">بەراوردی کارایی فارمەکان <span>| ئەمڕۆ</span></h5>

                <div class="row">
                  <div class="col-md-3">
                    <div class="card">
                      <div class="card-body text-center">
                        <h6 class="farm-color1">فارمی یەکەم</h6>
                        <h3 class="farm-color1" id="farm1Today">0</h3>
                        <p class="text-muted mb-0">هێلکە</p>
                        <div class="progress mt-2">
                          <div class="progress-bar bg-secondary" id="farm1Progress" role="progressbar"
                            style="width: 0%">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card">
                      <div class="card-body text-center">
                        <h6 class="farm-color2">فارمی دووەم</h6>
                        <h3 class="farm-color2" id="farm2Today">0</h3>
                        <p class="text-muted mb-0">هێلکە</p>
                        <div class="progress mt-2">
                          <div class="progress-bar bg-success" id="farm2Progress" role="progressbar" style="width: 0%">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card">
                      <div class="card-body text-center">
                        <h6 class="farm-color3">فارمی سێیەم</h6>
                        <h3 class="farm-color3" id="farm3Today">0</h3>
                        <p class="text-muted mb-0">هێلکە</p>
                        <div class="progress mt-2">
                          <div class="progress-bar bg-danger" id="farm3Progress" role="progressbar" style="width: 0%">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card">
                      <div class="card-body text-center">
                        <h6 class="text-primary">فارمی چوارەم</h6>
                        <h3 class="text-primary" id="farm4Today">0</h3>
                        <p class="text-muted mb-0">هێلکە</p>
                        <div class="progress mt-2">
                          <div class="progress-bar bg-primary" id="farm4Progress" role="progressbar" style="width: 0%">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity & Top Performing Farm -->
        <div class="row" dir="rtl">
          <!-- Recent Activity -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">چالاکیەکانی ئەمڕۆ <span>| تۆمارکردنەکان</span></h5>

                <div class="activity">
                  <div class="activity-item d-flex" id="activity1" style="display: none !important;">
                    <div class="activite-label"></div>
                    <i class="bi bi-circle-fill activity-badge text-white align-self-start"></i>
                    <div class="activity-content">
                       <strong></strong>
                    </div>
                  </div>

                  <div class="activity-item d-flex" id="activity2" style="display: none !important;">
                    <div class="activite-label"></div>
                    <i class="bi bi-circle-fill activity-badge text-white align-self-start"></i>
                    <div class="activity-content">
                       <strong></strong>
                    </div>
                  </div>

                  <div class="activity-item d-flex" id="activity3" style="display: none !important;">
                    <div class="activite-label"> </div>
                    <i class="bi bi-circle-fill activity-badge text-white align-self-start"></i>
                    <div class="activity-content">
                       <strong></strong>
                    </div>
                  </div>

                  <div class="activity-item d-flex" id="activity4" style="display: none !important;">
                    <div class="activite-label"></div>
                    <i class="bi bi-circle-fill activity-badge text-white align-self-start"></i>
                    <div class="activity-content">
                       <strong></strong>
                    </div>
                  </div>

                  <div class="activity-item d-flex" id="activity5" style="display: none !important;">
                    <div class="activite-label"></div>
                    <i class="bi bi-circle-fill activity-badge text-white align-self-start"></i>
                    <div class="activity-content">
                       <strong></strong>
                    </div>
                  </div>

                  <div id="noActivity">
                    <p class="text-muted text-center">هیچ چالاکیەک نییە بۆ ئەمڕۆ</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Top Performing Farm -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">باشترین فارم <span>| ئەم مانگە</span></h5>

                <div class="top-selling">
                  <table class="table table-borderless">
                    <thead>
                      <tr>
                        <th scope="col">ڕیز</th>
                        <th scope="col">فارم</th>
                        <th scope="col">هێلکە</th>
                        <th scope="col">ڕێژە</th>
                      </tr>
                    </thead>
                    <tbody id="topFarmsTable">
                      <tr>
                        <td colspan="4" class="text-center text-muted">چاوەڕێی داتا...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Overview -->
        <div class="row" dir="rtl">
          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">ئاماری گشتی <span>| کۆی هەموو فارمەکان</span></h5>

                <div class="row">
                  <div class="col-md-3">
                    <div class="card bg-info-light">
                      <div class="card-body text-center">
                        <i class="bi bi-calendar-check" style="font-size: 32px; color: #17a2b8;"></i>
                        <h6 class="mt-2">کۆی تۆمارەکان</h6>
                        <h3 id="totalRecords">0</h3>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card bg-success-light">
                      <div class="card-body text-center">
                        <i class="bi bi-graph-up-arrow" style="font-size: 32px; color: #28a745;"></i>
                        <h6 class="mt-2">نرخی گەشەکردن</h6>
                        <h3 id="growthRate">0%</h3>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card bg-warning-light">
                      <div class="card-body text-center">
                        <i class="bi bi-trophy" style="font-size: 32px; color: #ffc107;"></i>
                        <h6 class="mt-2">باشترین ڕۆژ</h6>
                        <h3 id="bestDay">-</h3>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card bg-danger-light">
                      <div class="card-body text-center">
                        <i class="bi bi-speedometer2" style="font-size: 32px; color: #dc3545;"></i>
                        <h6 class="mt-2">تێکڕای ڕۆژانە</h6>
                        <h3 id="dailyAverage">0</h3>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="row" dir="rtl">
          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">کردارە خێراکان</h5>

                <div class="row text-center">
                  <div class="col-md-3">
                    <a href="farm1.html" class="btn btn-outline-primary w-100 mb-2">
                      <i class="bi bi-plus-circle"></i> تۆمارکردنی نوێ
                    </a>
                  </div>
                  <div class="col-md-3">
                    <a href="calculation.html" class="btn btn-outline-success w-100 mb-2">
                      <i class="bi bi-calculator"></i> سەرژمێری گشتی
                    </a>
                  </div>
                  <div class="col-md-3">
                    <a href="#" onclick="generateDashboardReport()" class="btn btn-outline-warning w-100 mb-2">
                      <i class="bi bi-file-earmark-pdf"></i> ڕاپۆرتی داشبۆرد
                    </a>
                  </div>
                  <div class="col-md-3">
                    <a onclick="alert('ئەم خزمەتگوزاریە جارێ بەردەست نییە!');"
                      class="btn btn-outline-secondary w-100 mb-2">
                      <i class="bi bi-gear"></i> ڕێکخستنەکان
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

    </section>
  </main>

  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>Ballen Baxtyar</span></strong>. All Rights Reserved
    </div>
    <div class="credits">
      Designed by <a href="https://ballenio.vercel.app/">Ballen Baxtyar</a>
    </div>
  </footer>

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
  </a>

  <!-- Hidden Report Container -->
  <div id="reportContainer"></div>

  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/quill/quill.js"></script>
  <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
  <script src="assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/js/main.js"></script>

  <script src="/assets/js/auth.js"></script>
  <!-- Libraries for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Check authentication on page load
  // Check authentication on page load
  const user = checkAuth();
  
  if (user) {
    console.log('Logged in as watcher:', user.username);
    document.getElementById('userFirstname').textContent = user.firstname;
    document.getElementById('userFullname').textContent = `${user.firstname} ${user.lastname}`;
    document.getElementById('welcomeName').textContent = user.firstname;
    document.getElementById('userType').textContent = user.type;
  }

  // Override logout to redirect to correct path for watcher
  function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = 'login.html';
  }

    // Global variables
    let allRecords = [];
    let currentPeriod = 'today';

    // Load all farm data
    async function loadAllFarmsData() {
      try {
        const token = localStorage.getItem('token');

        const promises = [1, 2, 3, 4].map(farmNum =>
          fetch(`http://localhost:3000/farm${farmNum}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }).then(res => res.json())
        );

        const results = await Promise.all(promises);

        allRecords = [];
        results.forEach((result, index) => {
          const farmNumber = index + 1;
          if (result.records) {
            result.records.forEach(record => {
              allRecords.push({
                ...record,
                farmNumber: farmNumber,
                farmName: getFarmName(farmNumber)
              });
            });
          }
        });

        calculateDashboardStats('today');

      } catch (error) {
        console.error('Error loading farms data:', error);
      }
    }

    function getFarmName(num) {
      const names = {
        1: 'فارمی یەکەم',
        2: 'فارمی دووەم',
        3: 'فارمی سێیەم',
        4: 'فارمی چوارەم'
      };
      return names[num];
    }

    function changeTimePeriod(period) {
      currentPeriod = period;
      const labels = {
        'today': 'ئەمڕۆ',
        'week': 'ئەم حەفتەیە',
        'month': 'ئەم مانگە',
        'all': 'هەموو'
      };

      document.getElementById('periodLabel').textContent = '| ' + labels[period];
      document.getElementById('eggsLabel').textContent = labels[period];
      document.getElementById('flatsLabel').textContent = labels[period];
      document.getElementById('packetsLabel').textContent = labels[period];

      calculateDashboardStats(period);
    }

    function calculateDashboardStats(period) {
      const now = new Date();
      let filtered = [];
      let previousFiltered = [];

      if (period === 'today') {
        const today = now.toISOString().split('T')[0];
        filtered = allRecords.filter(r => r.createdAt.split('T')[0] === today);

        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        previousFiltered = allRecords.filter(r => r.createdAt.split('T')[0] === yesterdayStr);

      } else if (period === 'week') {
        const weekAgo = new Date(now);
        weekAgo.setDate(weekAgo.getDate() - 7);
        filtered = allRecords.filter(r => new Date(r.createdAt) >= weekAgo);

        const twoWeeksAgo = new Date(now);
        twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
        previousFiltered = allRecords.filter(r => {
          const date = new Date(r.createdAt);
          return date >= twoWeeksAgo && date < weekAgo;
        });

      } else if (period === 'month') {
        const monthAgo = new Date(now);
        monthAgo.setDate(monthAgo.getDate() - 30);
        filtered = allRecords.filter(r => new Date(r.createdAt) >= monthAgo);

        const twoMonthsAgo = new Date(now);
        twoMonthsAgo.setDate(twoMonthsAgo.getDate() - 60);
        previousFiltered = allRecords.filter(r => {
          const date = new Date(r.createdAt);
          return date >= twoMonthsAgo && date < monthAgo;
        });

      } else {
        filtered = allRecords;
        previousFiltered = [];
      }

      // Calculate totals
      const totalEggs = filtered.reduce((sum, r) => sum + r.eggs, 0);
      const totalFlats = filtered.reduce((sum, r) => sum + r.flats, 0);
      const totalPackets = filtered.reduce((sum, r) => sum + r.packets, 0);

      const prevEggs = previousFiltered.reduce((sum, r) => sum + r.eggs, 0);
      const prevFlats = previousFiltered.reduce((sum, r) => sum + r.flats, 0);
      const prevPackets = previousFiltered.reduce((sum, r) => sum + r.packets, 0);

      // Update main cards
      document.getElementById('totalEggs').textContent = totalEggs.toLocaleString();
      document.getElementById('totalFlats').textContent = totalFlats.toFixed(2);
      document.getElementById('totalPackets').textContent = totalPackets.toFixed(2);

      // Calculate percentages
      const eggsChange = prevEggs > 0 ? (((totalEggs - prevEggs) / prevEggs) * 100).toFixed(1) : 0;
      const flatsChange = prevFlats > 0 ? (((totalFlats - prevFlats) / prevFlats) * 100).toFixed(1) : 0;
      const packetsChange = prevPackets > 0 ? (((totalPackets - prevPackets) / prevPackets) * 100).toFixed(1) : 0;

      updatePercentage('eggsPercentage', eggsChange);
      updatePercentage('flatsPercentage', flatsChange);
      updatePercentage('packetsPercentage', packetsChange);

      // Calculate daily, weekly, monthly
      calculateTimePeriodComparison();

      // Calculate farm performance
      calculateFarmPerformance();

      // Update top farms
      updateTopFarms();

      // Update statistics overview
      updateStatisticsOverview();

      // Update activity
      updateRecentActivity();
    }

    function updatePercentage(elementId, value) {
      const element = document.getElementById(elementId);
      const numValue = parseFloat(value);

      if (numValue > 0) {
        element.className = 'text-success small pt-1 fw-bold';
        element.textContent = '+' + value + '%';
      } else if (numValue < 0) {
        element.className = 'text-danger small pt-1 fw-bold';
        element.textContent = value + '%';
      } else {
        element.className = 'text-muted small pt-1 fw-bold';
        element.textContent = value + '%';
      }
    }

    function calculateTimePeriodComparison() {
      const now = new Date();

      // Daily
      const today = now.toISOString().split('T')[0];
      const todayRecords = allRecords.filter(r => r.createdAt.split('T')[0] === today);
      const todayEggs = todayRecords.reduce((sum, r) => sum + r.eggs, 0);

      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toISOString().split('T')[0];
      const yesterdayRecords = allRecords.filter(r => r.createdAt.split('T')[0] === yesterdayStr);
      const yesterdayEggs = yesterdayRecords.reduce((sum, r) => sum + r.eggs, 0);

      document.getElementById('dailyToday').textContent = todayEggs.toLocaleString();
      document.getElementById('dailyYesterday').textContent = yesterdayEggs.toLocaleString();

      const dailyChange = yesterdayEggs > 0 ? (((todayEggs - yesterdayEggs) / yesterdayEggs) * 100).toFixed(1) : 0;
      document.getElementById('dailyChange').textContent = (dailyChange > 0 ? '+' : '') + dailyChange + '%';

      // Weekly
      const weekAgo = new Date(now);
      weekAgo.setDate(weekAgo.getDate() - 7);
      const thisWeekRecords = allRecords.filter(r => new Date(r.createdAt) >= weekAgo);
      const thisWeekEggs = thisWeekRecords.reduce((sum, r) => sum + r.eggs, 0);

      const twoWeeksAgo = new Date(now);
      twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
      const lastWeekRecords = allRecords.filter(r => {
        const date = new Date(r.createdAt);
        return date >= twoWeeksAgo && date < weekAgo;
      });
      const lastWeekEggs = lastWeekRecords.reduce((sum, r) => sum + r.eggs, 0);

      document.getElementById('weeklyThis').textContent = thisWeekEggs.toLocaleString();
      document.getElementById('weeklyLast').textContent = lastWeekEggs.toLocaleString();

      const weeklyChange = lastWeekEggs > 0 ? (((thisWeekEggs - lastWeekEggs) / lastWeekEggs) * 100).toFixed(1) : 0;
      document.getElementById('weeklyChange').textContent = (weeklyChange > 0 ? '+' : '') + weeklyChange + '%';

      // Monthly
      const monthAgo = new Date(now);
      monthAgo.setDate(monthAgo.getDate() - 30);
      const thisMonthRecords = allRecords.filter(r => new Date(r.createdAt) >= monthAgo);
      const thisMonthEggs = thisMonthRecords.reduce((sum, r) => sum + r.eggs, 0);

      const twoMonthsAgo = new Date(now);
      twoMonthsAgo.setDate(twoMonthsAgo.getDate() - 60);
      const lastMonthRecords = allRecords.filter(r => {
        const date = new Date(r.createdAt);
        return date >= twoMonthsAgo && date < monthAgo;
      });
      const lastMonthEggs = lastMonthRecords.reduce((sum, r) => sum + r.eggs, 0);

      document.getElementById('monthlyThis').textContent = thisMonthEggs.toLocaleString();
      document.getElementById('monthlyLast').textContent = lastMonthEggs.toLocaleString();

      const monthlyChange = lastMonthEggs > 0 ? (((thisMonthEggs - lastMonthEggs) / lastMonthEggs) * 100).toFixed(1) : 0;
      document.getElementById('monthlyChange').textContent = (monthlyChange > 0 ? '+' : '') + monthlyChange + '%';
    }

    function calculateFarmPerformance() {
      const now = new Date();
      const today = now.toISOString().split('T')[0];

      const farmTotals = {};
      let maxEggs = 0;

      for (let i = 1; i <= 4; i++) {
        const todayRecords = allRecords.filter(r =>
          r.farmNumber === i && r.createdAt.split('T')[0] === today
        );
        const eggs = todayRecords.reduce((sum, r) => sum + r.eggs, 0);
        farmTotals[i] = eggs;
        if (eggs > maxEggs) maxEggs = eggs;
      }

      for (let i = 1; i <= 4; i++) {
        document.getElementById(`farm${i}Today`).textContent = farmTotals[i].toLocaleString();
        const percentage = maxEggs > 0 ? (farmTotals[i] / maxEggs) * 100 : 0;
        document.getElementById(`farm${i}Progress`).style.width = percentage + '%';
      }
    }

    function updateTopFarms() {
      const now = new Date();
      const monthAgo = new Date(now);
      monthAgo.setDate(monthAgo.getDate() - 30);

      const farmTotals = {};

      for (let i = 1; i <= 4; i++) {
        const monthRecords = allRecords.filter(r =>
          r.farmNumber === i && new Date(r.createdAt) >= monthAgo
        );
        farmTotals[i] = monthRecords.reduce((sum, r) => sum + r.eggs, 0);
      }

      const sorted = Object.entries(farmTotals).sort((a, b) => b[1] - a[1]);
      const totalEggs = Object.values(farmTotals).reduce((sum, val) => sum + val, 0);

      const tableBody = document.getElementById('topFarmsTable');
      tableBody.innerHTML = sorted.map(([farmNum, eggs], index) => {
        const percentage = totalEggs > 0 ? ((eggs / totalEggs) * 100).toFixed(1) : 0;
        const badgeClass = index === 0 ? 'bg-success' : index === 1 ? 'bg-primary' : index === 2 ? 'bg-warning' : 'bg-secondary';

        return `
          <tr>
            <th scope="row"><span class="badge ${badgeClass}">${index + 1}</span></th>
            <td><strong>${getFarmName(parseInt(farmNum))}</strong></td>
            <td>${eggs.toLocaleString()}</td>
            <td><span class="badge bg-info">${percentage}%</span></td>
          </tr>
        `;
      }).join('');
    }

    function updateStatisticsOverview() {
      // Total records
      document.getElementById('totalRecords').textContent = allRecords.length.toLocaleString();

      // Growth rate (compare this month vs last month)
      const now = new Date();
      const monthAgo = new Date(now);
      monthAgo.setDate(monthAgo.getDate() - 30);
      const thisMonth = allRecords.filter(r => new Date(r.createdAt) >= monthAgo);
      const thisMonthEggs = thisMonth.reduce((sum, r) => sum + r.eggs, 0);

      const twoMonthsAgo = new Date(now);
      twoMonthsAgo.setDate(twoMonthsAgo.getDate() - 60);
      const lastMonth = allRecords.filter(r => {
        const date = new Date(r.createdAt);
        return date >= twoMonthsAgo && date < monthAgo;
      });
      const lastMonthEggs = lastMonth.reduce((sum, r) => sum + r.eggs, 0);

      const growthRate = lastMonthEggs > 0 ? (((thisMonthEggs - lastMonthEggs) / lastMonthEggs) * 100).toFixed(1) : 0;
      document.getElementById('growthRate').textContent = (growthRate > 0 ? '+' : '') + growthRate + '%';

      // Best day
      const dailyTotals = {};
      allRecords.forEach(r => {
        const date = r.createdAt.split('T')[0];
        if (!dailyTotals[date]) dailyTotals[date] = 0;
        dailyTotals[date] += r.eggs;
      });

      const bestDay = Object.entries(dailyTotals).sort((a, b) => b[1] - a[1])[0];
      if (bestDay) {
        document.getElementById('bestDay').textContent = `${bestDay[1].toLocaleString()}`;
      }

      // Daily average
      const totalDays = Object.keys(dailyTotals).length || 1;
      const totalEggs = allRecords.reduce((sum, r) => sum + r.eggs, 0);
      const average = Math.round(totalEggs / totalDays);
      document.getElementById('dailyAverage').textContent = average.toLocaleString();
    }

    function updateRecentActivity() {
      const now = new Date();
      const today = now.toISOString().split('T')[0];
      const todayRecords = allRecords.filter(r => r.createdAt.split('T')[0] === today)
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .slice(0, 5);

      if (todayRecords.length > 0) {
        document.getElementById('noActivity').style.display = 'none';

        // Clear all activities first
        for (let i = 1; i <= 5; i++) {
          const activityEl = document.getElementById(`activity${i}`);
          if (activityEl) {
            activityEl.style.display = 'none';
          }
        }

        // Populate with real data
        todayRecords.forEach((record, index) => {
          const activityEl = document.getElementById(`activity${index + 1}`);
          if (activityEl) {
            // Calculate time ago
            const recordTime = new Date(record.createdAt);
            const timeAgo = getTimeAgo(recordTime);

            // Get farm color class
            const colorClass = getFarmColorClass(record.farmNumber);

            // Update activity content
            const labelEl = activityEl.querySelector('.activite-label');
            const badgeEl = activityEl.querySelector('.activity-badge');
            const contentEl = activityEl.querySelector('.activity-content');

            if (labelEl) labelEl.textContent = timeAgo;
            if (badgeEl) badgeEl.className = `bi bi-circle-fill activity-badge ${colorClass} align-self-start`;
            if (contentEl) {
              contentEl.innerHTML = `تۆمارکردنی <strong>${record.eggs.toLocaleString()}</strong> هێلکە لە <strong>${record.farmName}</strong>`;
            }

            activityEl.style.display = 'flex';
          }
        });
      } else {
        document.getElementById('noActivity').style.display = 'block';
        for (let i = 1; i <= 5; i++) {
          const activityEl = document.getElementById(`activity${i}`);
          if (activityEl) {
            activityEl.style.display = 'none';
          }
        }
      }
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) {
        return 'ئێستا';
      } else if (diffMins < 60) {
        return `${diffMins} دەقە پێش ئێستا`;
      } else if (diffHours < 24) {
        return `${diffHours} کاتژمێر پێش ئێستا`;
      } else {
        return `${diffDays} ڕۆژ پێش ئێستا`;
      }
    }

    function getFarmColorClass(farmNum) {
      const colors = {
        1: 'text-secondary',
        2: 'text-success',
        3: 'text-danger',
        4: 'text-primary'
      };
      return colors[farmNum] || 'text-muted';
    }

    // Generate Dashboard Report
    // Generate Dashboard Report - WITH FILTER SUPPORT
    async function generateDashboardReport() {
      if (allRecords.length === 0) {
        alert('❌ هیچ داتایەک نییە بۆ دروستکردنی ڕاپۆرت');
        return;
      }

      // Show loading message
      const loadingMsg = document.createElement('div');
      loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px 50px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:99999;text-align:center;';
      loadingMsg.innerHTML = '<div style="font-size:20px;font-weight:bold;color:#667eea;margin-bottom:10px;">چاوەڕێبە...</div><div style="color:#666;">ڕاپۆرتەکە دروست دەکرێت</div>';
      document.body.appendChild(loadingMsg);

      // Use current period filter to get records
      const now = new Date();
      let filteredRecords = [];
      let periodText = '';

      if (currentPeriod === 'today') {
        const today = now.toISOString().split('T')[0];
        filteredRecords = allRecords.filter(r => r.createdAt.split('T')[0] === today);
        periodText = 'ئەمڕۆ';
      } else if (currentPeriod === 'week') {
        const weekAgo = new Date(now);
        weekAgo.setDate(weekAgo.getDate() - 7);
        filteredRecords = allRecords.filter(r => new Date(r.createdAt) >= weekAgo);
        periodText = 'ئەم حەفتەیە (7 ڕۆژی ڕابردوو)';
      } else if (currentPeriod === 'month') {
        const monthAgo = new Date(now);
        monthAgo.setDate(monthAgo.getDate() - 30);
        filteredRecords = allRecords.filter(r => new Date(r.createdAt) >= monthAgo);
        periodText = 'ئەم مانگە (30 ڕۆژی ڕابردوو)';
      } else {
        filteredRecords = allRecords;
        periodText = 'هەموو تۆمارەکان';
      }

      // Calculate statistics based on filtered records
      const totalEggs = filteredRecords.reduce((sum, r) => sum + r.eggs, 0);
      const totalFlats = filteredRecords.reduce((sum, r) => sum + r.flats, 0);
      const totalPackets = filteredRecords.reduce((sum, r) => sum + r.packets, 0);

      // Calculate farm statistics
      const farmStats = {};
      for (let i = 1; i <= 4; i++) {
        const farmRecords = filteredRecords.filter(r => r.farmNumber === i);
        farmStats[i] = {
          eggs: farmRecords.reduce((sum, r) => sum + r.eggs, 0),
          flats: farmRecords.reduce((sum, r) => sum + r.flats, 0),
          packets: farmRecords.reduce((sum, r) => sum + r.packets, 0),
          records: farmRecords.length
        };
      }

      // Build farm table rows
      let farmTableRows = '';
      for (let i = 1; i <= 4; i++) {
        farmTableRows += `
      <tr>
        <td>${getFarmName(i)}</td>
        <td>${farmStats[i].eggs.toLocaleString()}</td>
        <td>${farmStats[i].flats.toFixed(2)}</td>
        <td>${farmStats[i].packets.toFixed(2)}</td>
        <td>${farmStats[i].records}</td>
      </tr>
    `;
      }

      // Daily statistics from filtered records
      const dailyTotals = {};
      filteredRecords.forEach(r => {
        const date = r.createdAt.split('T')[0];
        if (!dailyTotals[date]) dailyTotals[date] = 0;
        dailyTotals[date] += r.eggs;
      });

      const bestDay = Object.entries(dailyTotals).sort((a, b) => b[1] - a[1])[0];
      const totalDays = Object.keys(dailyTotals).length || 1;
      const dailyAvg = Math.round(totalEggs / totalDays);

      // Create report HTML
      const reportHTML = `
    <div class="watermark">داشبۆرد</div>
    
    <div class="receipt-header">
      <h1>ڕاپۆرتی داشبۆرد</h1>
      <h2>سیستەمی سەرژمێری هێلکە - کورتەی ${periodText}</h2>
    </div>

    <div class="receipt-body">
      <div class="info-cards">
        <div class="info-card">
          <h3>زانیاری پڕۆگرام</h3>
          <p><strong>ناو:</strong> سەرژمێری هێلکە</p>
          <p><strong>ڕاپۆرت لەلایەن:</strong> ${user.firstname} ${user.lastname}</p>
          <p><strong>بەروار:</strong> ${new Date().toLocaleDateString('en-GB')}</p>
          <p><strong>کات:</strong> ${new Date().toLocaleTimeString('en-GB')}</p>
        </div>

        <div class="info-card">
          <h3>زانیاری ڕاپۆرت</h3>
          <p><strong>ژمارەی ڕاپۆرت:</strong> #DASH-${Date.now().toString().slice(-8)}</p>
          <p><strong>ماوە:</strong> ${periodText}</p>
          <p><strong>کۆی فارمەکان:</strong> 4 فارم</p>
          <p><strong>کۆی تۆمارەکان:</strong> ${filteredRecords.length.toLocaleString()}</p>
        </div>
      </div>

      <div class="summary-section">
        <h3 class="summary-title">کورتەی کۆی گشتی (${periodText})</h3>
        <div class="summary-cards">
          <div class="summary-card">
            <h4>کۆی هێلکە</h4>
            <p class="value">${totalEggs.toLocaleString()}</p>
          </div>
          <div class="summary-card">
            <h4>کۆی تەبەق</h4>
            <p class="value">${totalFlats.toFixed(2)}</p>
          </div>
          <div class="summary-card">
            <h4>کۆی کارتۆن</h4>
            <p class="value">${totalPackets.toFixed(2)}</p>
          </div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-box">
          <h4>کۆی گشتی هێلکە</h4>
          <div class="stat-value">${totalEggs.toLocaleString()}</div>
          <div class="stat-label">لە ${filteredRecords.length} تۆمار</div>
        </div>
        
        <div class="stat-box">
          <h4>باشترین ڕۆژ</h4>
          <div class="stat-value">${bestDay ? bestDay[1].toLocaleString() : 0}</div>
          <div class="stat-label">${bestDay ? new Date(bestDay[0]).toLocaleDateString('en-GB') : '-'}</div>
        </div>
        
        <div class="stat-box">
          <h4>تێکڕای ڕۆژانە</h4>
          <div class="stat-value">${dailyAvg.toLocaleString()}</div>
          <div class="stat-label">هێلکە لە ڕۆژێکدا</div>
        </div>
        
        <div class="stat-box">
          <h4>ژمارەی ڕۆژە چالاکەکان</h4>
          <div class="stat-value">${totalDays}</div>
          <div class="stat-label">ڕۆژی تۆمارکراو</div>
        </div>
      </div>

      <div class="table-section">
        <h3 class="table-title">بەراوردی فارمەکان (${periodText})</h3>
        <table class="receipt-table">
          <thead>
            <tr>
              <th>فارم</th>
              <th>هێلکە</th>
              <th>تەبەق</th>
              <th>کارتۆن</th>
              <th>تۆمار</th>
            </tr>
          </thead>
          <tbody>
            ${farmTableRows}
          </tbody>
        </table>
      </div>
    </div>

    <div class="receipt-footer">
      <div class="footer-line"></div>
      <p style="font-size:11px;margin-top:10px;opacity:0.8;">دروستکراوە لە: ${new Date().toLocaleString('en-GB')} © Designed by: Ballen Baxtyar 2026</p>
    </div>
  `;

      // Insert HTML into container
      const container = document.getElementById('reportContainer');
      container.innerHTML = reportHTML;
      container.style.left = '0';

      // Wait for rendering
      await new Promise(resolve => setTimeout(resolve, 500));

      try {
        // Convert HTML to canvas
        const canvas = await html2canvas(container, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#f5f7fa',
          width: 794,
          windowWidth: 794
        });

        // Convert canvas to PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'px',
          format: 'a4',
          compress: true
        });

        const imgData = canvas.toDataURL('image/png', 1.0);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();

        const imgWidth = canvas.width;
        const imgHeight = canvas.height;

        const ratio = pdfWidth / imgWidth;
        const scaledHeight = imgHeight * ratio;

        let heightLeft = scaledHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, scaledHeight, '', 'FAST');
        heightLeft -= pdfHeight;

        while (heightLeft > 0) {
          position = heightLeft - scaledHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, scaledHeight, '', 'FAST');
          heightLeft -= pdfHeight;
        }

        container.style.left = '-9999px';
        document.body.removeChild(loadingMsg);

        const pdfBlob = pdf.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        window.open(pdfUrl, '_blank');

      } catch (error) {
        console.error('Error generating PDF:', error);
        document.body.removeChild(loadingMsg);
        container.style.left = '-9999px';
        alert('❌ هەڵەیەک ڕوویدا لە دروستکردنی ڕاپۆرت: ' + error.message);
      }
    }
    // Load data on page load
    loadAllFarmsData();
  </script>
</body>

</html>