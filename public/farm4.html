<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>سەرژمێری هێلکە / فارمی 4</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <style>
    .filter {
      position: absolute;
      right: 20px;
      top: 15px;
      z-index: 10;
    }

    .filter .form-select {
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 5px 30px 5px 10px;
      font-size: 14px;
      color: #012970;
      background-color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter .form-select:hover {
      border-color: #4154f1;
    }

    .filter .form-select:focus {
      border-color: #4154f1;
      box-shadow: 0 0 0 0.2rem rgba(65, 84, 241, 0.25);
    }

    /* Receipt Styles */
    #receiptContainer {
      position: fixed;
      left: -9999px;
      top: 0;
      width: 794px;
      padding: 40px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Vazirmatn', sans-serif;
      direction: rtl;
      min-height: 100vh;
    }

    .watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 120px;
      color: rgba(102, 126, 234, 0.05);
      font-weight: 900;
      white-space: nowrap;
      z-index: 0;
      pointer-events: none;
    }

    .receipt-header {
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      border-radius: 15px 15px 0 0;
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .receipt-header h1 {
      margin: 0;
      font-size: 36px;
      font-weight: 800;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .receipt-header h2 {
      margin: 10px 0 0 0;
      font-size: 18px;
      font-weight: 400;
      opacity: 0.95;
    }

    .receipt-body {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 1;
    }

    .info-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
      padding: 20px;
      border-radius: 12px;
      border-right: 4px solid #667eea;
    }

    .info-card h3 {
      color: #667eea;
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    }

    .info-card p {
      margin: 8px 0;
      font-size: 13px;
      color: #333;
    }

    .info-card strong {
      color: #667eea;
      font-weight: 600;
    }

    .summary-section {
      margin: 30px 0;
    }

    .summary-title {
      color: #667eea;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border-radius: 10px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .summary-card h4 {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 10px 0;
      opacity: 0.95;
    }

    .summary-card .value {
      font-size: 28px;
      font-weight: 800;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 30px 0;
    }

    .stat-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .stat-box h4 {
      color: #667eea;
      font-size: 14px;
      margin: 0 0 10px 0;
    }

    .stat-box .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #012970;
      margin: 5px 0;
    }

    .stat-box .stat-label {
      font-size: 12px;
      color: #666;
    }

    .table-section {
      margin-top: 30px;
    }

    .table-title {
      color: #667eea;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
    }

    .receipt-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      border-radius: 10px;
      overflow: hidden;
    }

    .receipt-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .receipt-table thead th {
      padding: 15px 12px;
      font-weight: 700;
      font-size: 13px;
      text-align: center;
      border: none;
    }

    .receipt-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .receipt-table tbody td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
      font-size: 12px;
      color: #333;
    }

    .receipt-footer {
      margin-top: 30px;
      text-align: center;
      color: #666;
      position: relative;
      z-index: 1;
    }

    .footer-line {
      height: 3px;
      background: linear-gradient(90deg, transparent 0%, #667eea 50%, transparent 100%);
      margin-bottom: 15px;
    }
  </style>
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center">
        <span class="d-none d-lg-block">سەرژمێری هێلکە</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">

        <li class="nav-item dropdown pe-3">

          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle"></i> <span class="d-none d-md-block dropdown-toggle ps-2"
              id="headerUsername">بەڵێن</span>
          </a><!-- End Profile Iamge Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
              <h6 id="headerFullName">بەڵێن بەختیار</h6>
              <span id="headerUserType">ئەدمین</span>
            </li>

            <li>
              <hr class="dropdown-divider">
            </li>

            <li>
              <a class="dropdown-item d-flex align-items-center" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-left"></i>
                <span>چوونە دەرەوە</span>
              </a>
            </li>

          </ul><!-- End Profile Dropdown Items -->
        </li><!-- End Profile Nav -->

      </ul>
    </nav><!-- End Icons Navigation -->

  </header><!-- End Header -->

  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar">

    <ul class="sidebar-nav" id="sidebar-nav">

      <li class="nav-item">
        <a class="nav-link collapsed" href="index.html">
          <i class="bi bi-grid"></i>
          <span>داشبۆرد</span>
        </a>
      </li><!-- End Dashboard Nav -->

      <li class="nav-item">
        <a class="nav-link" data-bs-target="#components-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-house-door"></i><span>فارمەکان</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="components-nav" class="nav-content " data-bs-parent="#sidebar-nav">
          <li>
            <a href="farm1.html">
              <i class="bi bi-circle"></i>
              <span">فارمی یەکەم</span>
            </a>
          </li>
          <li>
            <a href="farm2.html">
              <i class="bi bi-circle"></i>
              <span">فارمی دووەم</span>
            </a>
          </li>
          <li>
            <a href="farm3.html">
              <i class="bi bi-circle"></i>
              <span">فارمی سێیەم</span>
            </a>
          </li>
          <li>
            <a href="farm4.html" class="active">
              <i class="bi bi-circle"></i>
              <span">فارمی چوارەم</span>
            </a>
          </li>
        </ul>
      </li><!-- End Components Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#forms-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-people"></i><span>بەکارهێنەرەکان</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="forms-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
          <li>
            <a href="admin.html">
              <i class="bi bi-circle"></i><span>ئەدمین</span>
            </a>
          </li>
          <li>
            <a href="watcher.html">
              <i class="bi bi-circle"></i><span>لاوەکی</span>
            </a>
          </li>
        </ul>
      </li><!-- End Forms Nav -->

      <li class="nav-heading">بەشەکان</li>

      <li class="nav-item">
        <a class="nav-link collapsed" href="calculation.html">
          <i class="bi bi-calculator"></i>
          <span>سەرژمێری</span>
        </a>
      </li><!-- End Profile Page Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" onclick="alert('ئەم خزمەتگوزاریە جارێ بەردەست نییە!');">
          <i class="bi bi-gear"></i>
          <span>ڕێکخستن</span>
        </a>
      </li><!-- End F.A.Q Page Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" href="#" onclick="logout()">
          <i class="bi bi-box-arrow-left"></i>
          <span>چوونە دەرەوە</span>
        </a>
      </li><!-- End Login Page Nav -->
    </ul>

  </aside><!-- End Sidebar-->

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>فارمی چوارەم</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item active">فارمی چوارەم</li>
          <li class="breadcrumb-item">فارمەکان</li>
          <li class="breadcrumb-item"><a href="index.html">داشبۆرد</a></li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <section class="section">
      <div class="row" dir="rtl">
        <div class="col-lg-12">

          <div class="card">
            <div class="card-body">

              <h5 class="card-title">داخڵکردنی فارمی چوار</h5>
              <form id="registerForm">
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="eggsnumber" placeholder="" required>
                      <label for="eggsnumber">عەدەدی هێلکە</label>
                    </div>
                  </div>

                  <div class="col-md-4">
                    <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="flatofeggs" placeholder="" required>
                      <label for="flatofeggs">عەدەدی تەبەق</label>
                    </div>
                  </div>

                  <div class="col-md-4">
                    <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="eggspacket" placeholder="" required>
                      <label for="eggspacket">عەدەدی کارتۆن</label>
                    </div>
                  </div>

                  <div class="col-md-12">
                    <div class="form-floating mb-3">
                      <input type="date" class="form-control date" id="todayDate">
                      <label for="todayDate">بەروار</label>
                    </div>
                  </div>

                  <div class="text-right pt-3 pb-1 p-3">
                    <button type="submit" class="btn btn-primary">داخڵکردن</button>
                  </div>
                </div>

              </form><!-- End General Form Elements -->

            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Filter Section -->
    <section class="section">
      <div class="row" dir="rtl">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">خشتەی فارمی چوار</h5>


              <div class="row">
                <!-- Date Range Filter -->
                <div class="col-md-3">
                  <div class="form-floating mb-3">
                    <input type="date" class="form-control" id="filterDateFrom">
                    <label for="filterDateFrom">لە بەروارێ</label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-floating mb-3">
                    <input type="date" class="form-control" id="filterDateTo">
                    <label for="filterDateTo">بۆ بەروارێ</label>
                  </div>
                </div>

                <!-- Quick Filters -->
                <div class="col-md-3">
                  <div class="form-floating mb-3">
                    <select class="form-select" id="filterQuick" onchange="applyQuickFilter()">
                      <option value="">هەڵبژاردنی خێرا</option>
                      <option value="week">حەفتەی ڕابردوو (7 ڕۆژ)</option>
                      <option value="month">مانگی ڕابردوو (30 ڕۆژ)</option>
                      <option value="month1">مانگی یەکەم</option>
                      <option value="month2">مانگی دووەم</option>
                      <option value="month3">مانگی سێیەم</option>
                      <option value="month4">مانگی چوارەم</option>
                      <option value="month5">مانگی پێنجەم</option>
                      <option value="month6">مانگی شەشەم</option>
                      <option value="month7">مانگی حەوتەم</option>
                      <option value="month8">مانگی هەشتەم</option>
                      <option value="month9">مانگی نۆیەم</option>
                      <option value="month10">مانگی دەیەم</option>
                      <option value="month11">مانگی یازدەیەم</option>
                      <option value="month12">مانگی دوانزەیەم</option>
                    </select>
                    <label for="filterQuick">فلتەری خێرا</label>
                  </div>
                </div>

                <!-- Year for specific month -->
                <div class="col-md-3">
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" id="filterYear" placeholder="2026" value="2026">
                    <label for="filterYear">ساڵ</label>
                  </div>
                </div>

                <!-- Filter Buttons -->
                <div class="col-md-12 text-center mb-3">
                  <button class="btn btn-primary" onclick="applyFilter()">
                    <i class="bi bi-funnel"></i> فلتەرکردن
                  </button>
                  <button class="btn btn-secondary" onclick="clearFilter()">
                    <i class="bi bi-x-circle"></i> سڕینەوەی فلتەر
                  </button>
                  <button class="btn btn-success" onclick="generateReceipt()">
                    <i class="bi bi-receipt"></i> دروستکردنی وەسڵ
                  </button>
                </div>

                <!-- Summary Statistics -->
                <div class="col-md-12">
                  <div class="alert alert-info" id="filterSummary" style="display: none;">
                    <h6 class="alert-heading">کۆی گشتی:</h6>
                    <div class="row">
                      <div class="col-md-4">
                        <strong>کۆی هێلکە:</strong> <span id="totalEggs">0</span>
                      </div>
                      <div class="col-md-4">
                        <strong>کۆی تەبەق:</strong> <span id="totalFlats">0</span>
                      </div>
                      <div class="col-md-4">
                        <strong>کۆی کارتۆن:</strong> <span id="totalPackets">0</span>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-md-12">
                        <strong>ژمارەی تۆمارەکان:</strong> <span id="totalRecords">0</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-body">

                <table class="table datatable table-farm">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">هێلکە</th>
                      <th scope="col">تەبەق</th>
                      <th scope="col">کارتۆن</th>
                      <th scope="col">بەرواری داخڵکردن</th>
                      <th scope="col">بەرواری گۆڕین</th>
                      <th scope="col">کردارەکان</th>
                    </tr>
                  </thead>
                  <tbody id="farmTableBody">
                    <tr>
                      <td colspan="7" class="text-center">چاوەڕێی داتا...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
    </section>

  </main><!-- End #main -->

  <!-- Update Modal -->
  <div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">گۆڕینی زانیاری</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" dir="rtl">
          <form id="updateForm">
            <input type="hidden" id="updateId">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="updateEggs" required>
              <label for="updateEggs">عەدەدی هێلکە</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="updateFlats" required>
              <label for="updateFlats">عەدەدی تەبەق</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="updatePackets" required>
              <label for="updatePackets">عەدەدی کارتۆن</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">داخستن</button>
          <button type="button" class="btn btn-primary" onclick="saveUpdate()">پاشەکەوتکردن</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>Ballen Baxtyar</span></strong>. All Rights Reserved
    </div>
    <div class="credits">
      Designed by <a href="https://ballenio.vercel.app/">Ballen Baxtyar</a>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Hidden Receipt Container -->
  <div id="receiptContainer" style="position:absolute;left:-9999px;"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/quill/quill.js"></script>
  <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
  <script src="assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

  <!-- Auth Script -->
  <script src="assets/js/auth.js"></script>

  <!-- Libraries for PDF generation from HTML -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Load settings
    const appSettings = window.getAppSettings ? window.getAppSettings() : {
      calculation: { eggsPerFlat: 30, flatsPerPacket: 12 },
      farms: { colors: {}, active: {} }
    };

    // Use dynamic calculation values
    const EGGS_PER_FLAT = appSettings.calculation.eggsPerFlat;
    const FLATS_PER_PACKET = appSettings.calculation.flatsPerPacket;
    const EGGS_PER_PACKET = EGGS_PER_FLAT * FLATS_PER_PACKET;

    // Apply farm colors
    if (appSettings.farms.colors.farm1) {
      const style = document.createElement('style');
      style.textContent = `
    .farm-1-row { background-color: ${appSettings.farms.colors.farm1} !important; }
    .farm-2-row { background-color: ${appSettings.farms.colors.farm2} !important; }
    .farm-3-row { background-color: ${appSettings.farms.colors.farm3} !important; }
    .farm-4-row { background-color: ${appSettings.farms.colors.farm4} !important; }
  `;
      document.head.appendChild(style);
    }

    // Check authentication
    const currentUser = checkAuth();
    if (currentUser) {
      document.getElementById('headerUsername').textContent = currentUser.firstname;
      document.getElementById('headerFullName').textContent = `${currentUser.firstname} ${currentUser.lastname}`;
      document.getElementById('headerUserType').textContent = currentUser.type;
    }

    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('todayDate').value = today;

    // Load farm data on page load
    loadFarmData();

    let allRecords = []; // Store all records for filtering
    let filteredRecords = []; // Store currently filtered records

    // ========== CALCULATION LOGIC FOR REGISTRATION FORM ==========
    const eggsInput = document.getElementById("eggsnumber");
    const flatsInput = document.getElementById("flatofeggs");
    const packetsInput = document.getElementById("eggspacket");

    let isUpdating = false;

    eggsInput.addEventListener("input", () => {
      if (isUpdating) return;
      isUpdating = true;
      const eggs = Number(eggsInput.value) || 0;
      flatsInput.value = (eggs / EGGS_PER_FLAT).toFixed(2);
      packetsInput.value = (eggs / EGGS_PER_PACKET).toFixed(2);
      isUpdating = false;
    });

    flatsInput.addEventListener("input", () => {
      if (isUpdating) return;
      isUpdating = true;
      const flats = Number(flatsInput.value) || 0;
      eggsInput.value = flats * EGGS_PER_FLAT;
      packetsInput.value = (flats / FLATS_PER_PACKET).toFixed(2);
      isUpdating = false;
    });

    packetsInput.addEventListener("input", () => {
      if (isUpdating) return;
      isUpdating = true;
      const packets = Number(packetsInput.value) || 0;
      flatsInput.value = packets * FLATS_PER_PACKET;
      eggsInput.value = packets * EGGS_PER_PACKET;
      isUpdating = false;
    });

    // ========== CALCULATION LOGIC FOR UPDATE MODAL ==========
    const updateEggsInput = document.getElementById("updateEggs");
    const updateFlatsInput = document.getElementById("updateFlats");
    const updatePacketsInput = document.getElementById("updatePackets");

    let isUpdatingModal = false;

    updateEggsInput.addEventListener("input", () => {
      if (isUpdatingModal) return;
      isUpdatingModal = true;
      const eggs = Number(updateEggsInput.value) || 0;
      updateFlatsInput.value = (eggs / EGGS_PER_FLAT).toFixed(2);
      updatePacketsInput.value = (eggs / EGGS_PER_PACKET).toFixed(2);
      isUpdatingModal = false;
    });

    updateFlatsInput.addEventListener("input", () => {
      if (isUpdatingModal) return;
      isUpdatingModal = true;
      const flats = Number(updateFlatsInput.value) || 0;
      updateEggsInput.value = flats * EGGS_PER_FLAT;
      updatePacketsInput.value = (flats / FLATS_PER_PACKET).toFixed(2);
      isUpdatingModal = false;
    });

    updatePacketsInput.addEventListener("input", () => {
      if (isUpdatingModal) return;
      isUpdatingModal = true;
      const packets = Number(updatePacketsInput.value) || 0;
      updateFlatsInput.value = packets * FLATS_PER_PACKET;
      updateEggsInput.value = packets * EGGS_PER_PACKET;
      isUpdatingModal = false;
    });

    // ========== FORM SUBMISSION ==========
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const eggs = Number(document.getElementById('eggsnumber').value);
      const flats = Number(document.getElementById('flatofeggs').value);
      const packets = Number(document.getElementById('eggspacket').value);
      const date = document.getElementById('todayDate').value;

      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/farm4', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ eggs, flats, packets, date })
        });

        const data = await res.json();

        if (res.ok) {
          alert('✅ داتا تۆمارکرا');
          document.getElementById('registerForm').reset();
          document.getElementById('todayDate').value = today;
          loadFarmData();
        } else {
          alert('❌ ' + data.message);
        }
      } catch (error) {
        alert('❌ هەڵەیەک ڕوویدا: ' + error.message);
      }
    });

    // ========== LOAD FARM DATA ==========
    async function loadFarmData() {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/farm4', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await res.json();

        if (res.ok) {
          allRecords = data.records; // Store all records
          filteredRecords = allRecords; // Initialize filtered records
          displayFarmData(allRecords);
        }
      } catch (error) {
        console.error('Error loading farm data:', error);
      }
    }

    // ========== DISPLAY FARM DATA ==========
    function displayFarmData(records) {
      const tbody = document.getElementById('farmTableBody');

      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">هیچ داتایەک نییە</td></tr>';
        document.getElementById('filterSummary').style.display = 'none';
        return;
      }

      tbody.innerHTML = records.map((record, index) => `
        <tr>
          <th scope="row">${index + 1}</th>
          <td>${record.eggs}</td>
          <td>${record.flats}</td>
          <td>${record.packets}</td>
          <td>${new Date(record.createdAt).toLocaleDateString('en-GB')}</td>
          <td>${record.updatedAt ? new Date(record.updatedAt).toLocaleDateString('en-GB') : '-'}</td>
          <td>
            <button class="btn btn-warning btn-sm" onclick='openUpdateModal(${JSON.stringify(record)})'>
              <i class="bi bi-pencil"></i> گۆڕین
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteFarmRecord('${record._id}')">
              <i class="bi bi-trash"></i> سڕینەوە
            </button>
          </td>
        </tr>
      `).join('');

      // Update summary
      updateSummary(records);
    }

    // ========== UPDATE SUMMARY ==========
    function updateSummary(records) {
      const totalEggs = records.reduce((sum, r) => sum + r.eggs, 0);
      const totalFlats = records.reduce((sum, r) => sum + r.flats, 0);
      const totalPackets = records.reduce((sum, r) => sum + r.packets, 0);

      document.getElementById('totalEggs').textContent = totalEggs.toLocaleString();
      document.getElementById('totalFlats').textContent = totalFlats.toFixed(2);
      document.getElementById('totalPackets').textContent = totalPackets.toFixed(2);
      document.getElementById('totalRecords').textContent = records.length;
      document.getElementById('filterSummary').style.display = 'block';
    }

    // ========== QUICK FILTER ==========
    function applyQuickFilter() {
      const quickFilter = document.getElementById('filterQuick').value;
      const year = parseInt(document.getElementById('filterYear').value) || new Date().getFullYear();

      if (!quickFilter) return;

      const today = new Date();
      let fromDate, toDate;

      if (quickFilter === 'week') {
        toDate = new Date();
        fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - 7);
      } else if (quickFilter === 'month') {
        toDate = new Date();
        fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - 30);
      } else if (quickFilter.startsWith('month')) {
        const monthNum = parseInt(quickFilter.replace('month', ''));
        fromDate = new Date(year, monthNum - 1, 1);
        toDate = new Date(year, monthNum, 0);
      }

      if (fromDate && toDate) {
        document.getElementById('filterDateFrom').value = fromDate.toISOString().split('T')[0];
        document.getElementById('filterDateTo').value = toDate.toISOString().split('T')[0];
        applyFilter();
      }
    }

    // ========== APPLY FILTER ==========
    function applyFilter() {
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;

      let filtered = allRecords;

      if (dateFrom || dateTo) {
        filtered = allRecords.filter(record => {
          const recordDate = new Date(record.createdAt);
          const from = dateFrom ? new Date(dateFrom) : new Date('1900-01-01');
          const to = dateTo ? new Date(dateTo) : new Date('2100-12-31');
          to.setHours(23, 59, 59, 999);
          return recordDate >= from && recordDate <= to;
        });
      }

      filteredRecords = filtered; // Update filtered records
      displayFarmData(filtered);
    }

    // ========== CLEAR FILTER ==========
    function clearFilter() {
      document.getElementById('filterDateFrom').value = '';
      document.getElementById('filterDateTo').value = '';
      document.getElementById('filterQuick').value = '';
      document.getElementById('filterYear').value = new Date().getFullYear();
      filteredRecords = allRecords;
      displayFarmData(allRecords);
    }

    // ========== OPEN UPDATE MODAL ==========
    function openUpdateModal(record) {
      document.getElementById('updateId').value = record._id;
      document.getElementById('updateEggs').value = record.eggs;
      document.getElementById('updateFlats').value = record.flats;
      document.getElementById('updatePackets').value = record.packets;

      const modal = new bootstrap.Modal(document.getElementById('updateModal'));
      modal.show();
    }

    // ========== SAVE UPDATE ==========
    async function saveUpdate() {
      const id = document.getElementById('updateId').value;
      const eggs = Number(document.getElementById('updateEggs').value);
      const flats = Number(document.getElementById('updateFlats').value);
      const packets = Number(document.getElementById('updatePackets').value);

      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`/farm4/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ eggs, flats, packets })
        });

        const data = await res.json();

        if (res.ok) {
          alert('✅ داتا نوێکرایەوە');
          bootstrap.Modal.getInstance(document.getElementById('updateModal')).hide();
          loadFarmData();
        } else {
          alert('❌ ' + data.message);
        }
      } catch (error) {
        alert('❌ هەڵەیەک ڕوویدا: ' + error.message);
      }
    }

    // ========== DELETE RECORD ==========
    async function deleteFarmRecord(id) {
      if (!confirm('دڵنیایت لە سڕینەوەی ئەم داتایە؟')) {
        return;
      }

      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`/farm4/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await res.json();

        if (res.ok) {
          alert('✅ داتا سڕایەوە');
          loadFarmData();
        } else {
          alert('❌ ' + data.message);
        }
      } catch (error) {
        alert('❌ هەڵەیەک ڕوویدا: ' + error.message);
      }
    }

    // ========== GENERATE RECEIPT ==========
    async function generateReceipt() {
      if (filteredRecords.length === 0) {
        alert('❌ هیچ داتایەک بۆ دروستکردنی وەسڵ نییە');
        return;
      }

      // Show loading message
      const loadingMsg = document.createElement('div');
      loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px 50px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:99999;text-align:center;';
      loadingMsg.innerHTML = '<div style="font-size:20px;font-weight:bold;color:#667eea;margin-bottom:10px;">چاوەڕێبە...</div><div style="color:#666;">وەسڵەکە دروست دەکرێت</div>';
      document.body.appendChild(loadingMsg);

      // Calculate totals
      const totalEggs = filteredRecords.reduce((sum, r) => sum + r.eggs, 0);
      const totalFlats = filteredRecords.reduce((sum, r) => sum + r.flats, 0);
      const totalPackets = filteredRecords.reduce((sum, r) => sum + r.packets, 0);

      // Get date range
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;
      let dateRangeText = 'هەموو تۆمارەکان';
      if (dateFrom && dateTo) {
        dateRangeText = `لە ${dateFrom} بۆ ${dateTo}`;
      } else if (dateFrom) {
        dateRangeText = `لە ${dateFrom}`;
      } else if (dateTo) {
        dateRangeText = `تا ${dateTo}`;
      }

      // Build table rows
      let tableRows = '';
      filteredRecords.forEach((record, index) => {
        tableRows += `
          <tr>
            <td>${index + 1}</td>
            <td>${new Date(record.createdAt).toLocaleDateString('en-GB')}</td>
            <td>${record.eggs.toLocaleString()}</td>
            <td>${record.flats.toFixed(2)}</td>
            <td>${record.packets.toFixed(2)}</td>
          </tr>
        `;
      });

      // Create receipt HTML
      const receiptHTML = `
        <div class="watermark">سەرژمێری</div>
        
        <div class="receipt-header">
          <h1>وەسڵی داخڵکردن</h1>
          <h2>فارمی چوارەم - کورتەی داخڵکردنی هێلکە</h2>
        </div>

        <div class="receipt-body">
          <div class="info-cards">
            <div class="info-card">
              <h3>زانیاری کۆمپانیا</h3>
              <p><strong>ناو:</strong> سەرژمێری هێلکە</p>
              <p><strong>دەرچووکراو لەلایەن:</strong> ${currentUser.firstname} ${currentUser.lastname}</p>
              <p><strong>بەروار:</strong> ${new Date().toLocaleDateString('en-GB')}</p>
              <p><strong>کات:</strong> ${new Date().toLocaleTimeString('en-GB')}</p>
            </div>

            <div class="info-card">
              <h3>زانیاری وەسڵ</h3>
              <p><strong>ژمارەی وەسڵ:</strong> #${Date.now().toString().slice(-8)}</p>
              <p><strong>ماوە:</strong> ${dateRangeText}</p>
              <p><strong>کۆی تۆمارەکان:</strong> ${filteredRecords.length}</p>
              <p><strong>فارم:</strong> فارمی چوارەم</p>
            </div>
          </div>

          <div class="summary-section">
            <h3 class="summary-title">کورتەی داخڵکردن</h3>
            <div class="summary-cards">
              <div class="summary-card">
                <h4>کۆی هێلکە</h4>
                <p class="value">${totalEggs.toLocaleString()}</p>
              </div>
              <div class="summary-card">
                <h4>کۆی تەبەق</h4>
                <p class="value">${totalFlats.toFixed(2)}</p>
              </div>
              <div class="summary-card">
                <h4>کۆی کارتۆن</h4>
                <p class="value">${totalPackets.toFixed(2)}</p>
              </div>
            </div>
          </div>

          <div class="table-section">
            <h3 class="table-title">وردەکاری تۆمارەکان</h3>
            <table class="receipt-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>بەروار</th>
                  <th>هێلکە</th>
                  <th>تەبەق</th>
                  <th>کارتۆن</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        </div>

        <div class="receipt-footer">
          <div class="footer-line"></div>
          <p style="font-size:11px;margin-top:10px;opacity:0.8;">دروستکراوە لە: ${new Date().toLocaleString('en-GB')} © Designed by: Ballen Baxtyar 2026</p>
        </div>
      `;

      // Insert HTML into container
      const container = document.getElementById('receiptContainer');
      container.innerHTML = receiptHTML;
      container.style.left = '0';

      // Wait for fonts and images to load
      await new Promise(resolve => setTimeout(resolve, 500));

      try {
        // Convert HTML to canvas
        const canvas = await html2canvas(container, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#f5f7fa',
          width: 794, // A4 width in pixels at 96 DPI
          height: 1123 // A4 height in pixels at 96 DPI
        });

        // Convert canvas to PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const imgData = canvas.toDataURL('image/png');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

        // Hide container
        container.style.left = '-9999px';

        // Remove loading message
        document.body.removeChild(loadingMsg);

        // Open PDF in new tab
        const pdfBlob = pdf.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        window.open(pdfUrl, '_blank');

      } catch (error) {
        console.error('Error generating PDF:', error);
        document.body.removeChild(loadingMsg);
        container.style.left = '-9999px';
        alert('❌ هەڵەیەک ڕوویدا لە دروستکردنی وەسڵ: ' + error.message);
      }
    }
    
  </script>

</body>

</html>