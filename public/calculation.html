<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>سەرژمێری هێلکە</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <style>
  </style>
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center">
        <span class="d-none d-lg-block">سەرژمێری هێلکە</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">

        <li class="nav-item dropdown pe-3">

          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle"></i> <span class="d-none d-md-block dropdown-toggle ps-2"
              id="headerUsername">بەڵێن</span>
          </a><!-- End Profile Iamge Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
              <h6 id="headerFullName">بەڵێن بەختیار</h6>
              <span id="headerUserType">ئەدمین</span>
            </li>

            <li>
              <hr class="dropdown-divider">
            </li>

            <li>
              <a class="dropdown-item d-flex align-items-center" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-left"></i>
                <span>چوونە دەرەوە</span>
              </a>
            </li>

          </ul><!-- End Profile Dropdown Items -->
        </li><!-- End Profile Nav -->

      </ul>
    </nav><!-- End Icons Navigation -->

  </header><!-- End Header -->

  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar">

    <ul class="sidebar-nav" id="sidebar-nav">

      <li class="nav-item">
        <a class="nav-link collapsed" href="index.html">
          <i class="bi bi-grid"></i>
          <span>داشبۆرد</span>
        </a>
      </li><!-- End Dashboard Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#components-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-house-door"></i><span>فارمەکان</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="components-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
          <li>
            <a href="farm1.html">
              <i class="bi bi-circle"></i><span>فارمی یەکەم</span>
            </a>
          </li>
          <li>
            <a href="farm2.html">
              <i class="bi bi-circle"></i><span>فارمی دووەم</span>
            </a>
          </li>
          <li>
            <a href="farm3.html">
              <i class="bi bi-circle"></i><span>فارمی سێیەم</span>
            </a>
          </li>
          <li>
            <a href="farm4.html">
              <i class="bi bi-circle"></i><span>فارمی چوارەم</span>
            </a>
          </li>
        </ul>
      </li><!-- End Components Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#forms-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-people"></i><span>بەکارهێنەرەکان</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="forms-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
          <li>
            <a href="admin.html">
              <i class="bi bi-circle"></i><span>ئەدمین</span>
            </a>
          </li>
          <li>
            <a href="watcher.html">
              <i class="bi bi-circle"></i><span>لاوەکی</span>
            </a>
          </li>
        </ul>
      </li><!-- End Forms Nav -->

      <li class="nav-heading">بەشەکان</li>

      <li class="nav-item">
        <a class="nav-link" href="calculation.html">
          <i class="bi bi-calculator"></i>
          <span>سەرژمێری</span>
        </a>
      </li><!-- End Profile Page Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" href="settings.html">
          <i class="bi bi-gear"></i>
          <span>ڕێکخستن</span>
        </a>
      </li><!-- End F.A.Q Page Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" href="#" onclick="logout()">
          <i class="bi bi-box-arrow-left"></i>
          <span>چوونە دەرەوە</span>
        </a>
      </li><!-- End Login Page Nav -->
    </ul>

  </aside><!-- End Sidebar-->

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>سەرژمێری</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item active">سەرژمێری</li>
          <li class="breadcrumb-item"><a href="index.html">داشبۆرد</a></li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <!-- Summary Cards -->
    <section class="section dashboard">
      <div class="row" dir="">
        <div class="col-xxl-3 col-md-6">
          <div class="card info-card sales-card pt-0">
            <div class="card-body">
              <h5 class="card-title">کۆی گشتی <span>| هێلکە</span></h5>
              <div class="d-flex align-items-center">
                <div class="card card-icon rounded-circle d-flex align-items-center justify-content-center">
                  <i class="bi bi-egg"></i>
                </div>
                <div class="ps-3">
                  <h6 id="totalEggsCard">0</h6>
                  <span class="text-muted small pt-2 ps-1">هێلکە</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xxl-3 col-md-6">
          <div class="card info-card revenue-card pt-0">
            <div class="card-body">
              <h5 class="card-title">کۆی گشتی <span>| تەبەق</span></h5>
              <div class="d-flex align-items-center">
                <div class="card card-icon rounded-circle d-flex align-items-center justify-content-center">
                  <i class="bi bi-stack"></i>
                </div>
                <div class="ps-3">
                  <h6 id="totalFlatsCard">0</h6>
                  <span class="text-muted small pt-2 ps-1">تەبەق</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xxl-3 col-md-6">
          <div class="card info-card customers-card pt-0">
            <div class="card-body">
              <h5 class="card-title">کۆی گشتی <span>| کارتۆن</span></h5>
              <div class="d-flex align-items-center">
                <div class="card card-icon rounded-circle d-flex align-items-center justify-content-center">
                  <i class="bi bi-box"></i>
                </div>
                <div class="ps-3">
                  <h6 id="totalPacketsCard">0</h6>
                  <span class="text-muted small pt-2 ps-1">کارتۆن</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xxl-3 col-md-6">
          <div class="card  info-card pt-0">
            <div class="card-body">
              <h5 class="card-title">کۆی <span>| تۆمارەکان</span></h5>
              <div class="d-flex align-items-center">
                <div class="card card-icon rounded-circle d-flex align-items-center justify-content-center">
                  <i class="bi bi-file-text"></i>
                </div>
                <div class="ps-3">
                  <h6 id="totalRecordsCard">0</h6>
                  <span class="text-muted small pt-2 ps-1">تۆمار</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Advanced Filters -->
    <section class="section">
      <div class="row" dir="rtl">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">فلتەرکردن و گەڕان</h5>

              <div class="row">
                <!-- Farm Filter -->
                <div class="col-md-4">
                  <div class="form-floating mb-3">
                    <select class="form-select" id="filterFarm">
                      <option value="">هەموو فارمەکان</option>
                      <option value="1">فارمی یەکەم</option>
                      <option value="2">فارمی دووەم</option>
                      <option value="3">فارمی سێیەم</option>
                      <option value="4">فارمی چوارەم</option>
                    </select>
                    <label for="filterFarm">هەڵبژاردنی فارم</label>
                  </div>
                </div>
                <!-- Search -->
                <div class="col-md-4">
                  <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="گەڕان...">
                    <label for="searchInput">گەڕان (هێلکە، تەبەق، کارتۆن)</label>
                  </div>
                </div>

                <!-- Sort -->
                <div class="col-md-4">
                  <div class="form-floating mb-3">
                    <select class="form-select" id="sortBy">
                      <option value="date-desc">بەرواری نوێترین</option>
                      <option value="date-asc">بەرواری کۆنترین</option>
                      <option value="eggs-desc">هێلکە (زۆرترین)</option>
                      <option value="eggs-asc">هێلکە (کەمترین)</option>
                      <option value="farm-asc">فارم (1-4)</option>
                    </select>
                    <label for="sortBy">ڕیزکردن</label>
                  </div>
                </div>



                <!-- Quick Filters -->
                <div class="col-md-4">
                  <div class="form-floating mb-3">
                    <select class="form-select" id="filterQuick" onchange="applyQuickFilter()">
                      <option value="">هەڵبژاردن</option>
                      <option value="today">ئەمڕۆ</option>
                      <option value="week">حەفتەی ڕابردوو (7 ڕۆژ)</option>
                      <option value="month">مانگی ڕابردوو (30 ڕۆژ)</option>
                      <option value="month1">مانگی یەکەم</option>
                      <option value="month2">مانگی دووەم</option>
                      <option value="month3">مانگی سێیەم</option>
                      <option value="month4">مانگی چوارەم</option>
                      <option value="month5">مانگی پێنجەم</option>
                      <option value="month6">مانگی شەشەم</option>
                      <option value="month7">مانگی حەوتەم</option>
                      <option value="month8">مانگی هەشتەم</option>
                      <option value="month9">مانگی نۆیەم</option>
                      <option value="month10">مانگی دەیەم</option>
                      <option value="month11">مانگی یازدەیەم</option>
                      <option value="month12">مانگی دوانزەیەم</option>
                    </select>
                    <label for="filterQuick">فلتەری خێرا</label>
                  </div>
                </div>
                <!-- Date Range -->
                <div class="col-md-3">
                  <div class="form-floating mb-5">
                    <input type="date" class="form-control" id="filterDateFrom">
                    <label for="filterDateFrom">لە بەرواری</label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-floating mb-3">
                    <input type="date" class="form-control" id="filterDateTo">
                    <label for="filterDateTo">بۆ بەرواری</label>
                  </div>
                </div>
                <!-- Year -->
                <div class="col-md-2">
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" id="filterYear" value="2026">
                    <label for="filterYear">ساڵ</label>
                  </div>
                </div>



                <!-- Filter Buttons -->
                <div class="col-md-12 text-center mb-3">
                  <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="bi bi-funnel"></i> فلتەرکردن
                  </button>
                  <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> سڕینەوەی فلتەر
                  </button>
                  <button class="btn btn-success" onclick="generateReceipt()">
                    <i class="bi bi-receipt"></i> دروستکردنی وەسڵ
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Farms calculation section -->
    <section class="section">
      <div class="row" dir="rtl">
        <div class="col-lg-12">

          <div class="card">
            <div class="card-body">

              <h5 class="card-title">سەرژمێری کۆی فارمەکان</h5>

              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">فارم</th>
                      <th scope="col">کارتۆن</th>
                      <th scope="col">تەبەق</th>
                      <th scope="col">هێلکە</th>
                      <th scope="col">کۆی گشتی</th>
                      <th scope="col">بەرواری داخڵکردن</th>
                      <th scope="col">بەرواری گۆڕین</th>
                    </tr>
                  </thead>
                  <tbody id="calculationTableBody">
                    <tr>
                      <td colspan="8" class="text-center">چاوەڕێی داتا...</td>
                    </tr>
                  </tbody>
                  <tfoot id="calculationTableFooter" style="display: none;">
                    <tr class="total-row table-dark">
                      <td colspan="2"><strong>کۆی گشتی</strong></td>
                      <td><strong id="footerTotalPackets">0</strong></td>
                      <td><strong id="footerTotalFlats">0</strong></td>
                      <td><strong id="footerTotalEggsIndividual">0</strong></td>
                      <td><strong id="footerTotalEggs">0</strong> هێلکە </td>
                      <td colspan="2"><strong id="footerTotalRecords">0</strong> تۆمار </td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <!-- Pagination Controls -->
              <div class="pagination-container">
                <div class="page-size-selector">
                  <label>نیشاندانی:</label>
                  <select id="pageSize" onchange="changePageSize()">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                  <span>تۆمار لە هەر پەڕەیەک</span>
                </div>

                <div class="pagination-info">
                  نیشاندانی <strong id="showingFrom">0</strong> بۆ <strong id="showingTo">0</strong> لە <strong
                    id="totalItems">0</strong> تۆمار
                </div>

                <div class="pagination-controls">
                  <button onclick="goToFirstPage()" id="firstPageBtn">
                    <i class="bi bi-chevron-double-right"></i>
                  </button>
                  <button onclick="previousPage()" id="prevPageBtn">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                  <span class="page-number">
                    پەڕەی <strong id="currentPage">1</strong> لە <strong id="totalPages">1</strong>
                  </span>
                  <button onclick="nextPage()" id="nextPageBtn">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                  <button onclick="goToLastPage()" id="lastPageBtn">
                    <i class="bi bi-chevron-double-left"></i>
                  </button>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Individual Farm Summaries -->
    <section class="section">
      <div class="row" dir="rtl">
        <div class="col-lg-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title" style="background-color: #f8f9fa; padding: 10px; border-radius: 5px;">فارمی یەکەم
              </h5>
              <p>هێلکە: <strong id="farm1Eggs">0</strong></p>
              <p>تەبەق: <strong id="farm1Flats">0</strong></p>
              <p>کارتۆن: <strong id="farm1Packets">0</strong></p>
              <p>تۆمار: <strong id="farm1Records">0</strong></p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title" style="background-color: #d1e7dd; padding: 10px; border-radius: 5px;">فارمی دووەم
              </h5>
              <p>هێلکە: <strong id="farm2Eggs">0</strong></p>
              <p>تەبەق: <strong id="farm2Flats">0</strong></p>
              <p>کارتۆن: <strong id="farm2Packets">0</strong></p>
              <p>تۆمار: <strong id="farm2Records">0</strong></p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title" style="background-color: #f8d7da; padding: 10px; border-radius: 5px;">فارمی سێیەم
              </h5>
              <p>هێلکە: <strong id="farm3Eggs">0</strong></p>
              <p>تەبەق: <strong id="farm3Flats">0</strong></p>
              <p>کارتۆن: <strong id="farm3Packets">0</strong></p>
              <p>تۆمار: <strong id="farm3Records">0</strong></p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title" style="background-color: #cfe2ff; padding: 10px; border-radius: 5px;">فارمی چوارەم
              </h5>
              <p>هێلکە: <strong id="farm4Eggs">0</strong></p>
              <p>تەبەق: <strong id="farm4Flats">0</strong></p>
              <p>کارتۆن: <strong id="farm4Packets">0</strong></p>
              <p>تۆمار: <strong id="farm4Records">0</strong></p>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>Ballen Baxtyar</span></strong>. All Rights Reserved
    </div>
    <div class="credits">
      Designed by <a href="https://ballenio.vercel.app/">Ballen Baxtyar</a>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Hidden Receipt Container -->
  <div id="receiptContainer"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/quill/quill.js"></script>
  <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
  <script src="assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

  <!-- Auth Script -->
  <script src="assets/js/auth.js"></script>

  <!-- Libraries for PDF generation from HTML -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Check authentication
    const currentUser = checkAuth();
    if (currentUser) {
      document.getElementById('headerUsername').textContent = currentUser.firstname;
      document.getElementById('headerFullName').textContent = `${currentUser.firstname} ${currentUser.lastname}`;
      document.getElementById('headerUserType').textContent = currentUser.type;
    }

    let allRecords = [];
    let filteredRecords = [];

    // Pagination variables
    let currentPage = 1;
    let pageSize = 5;
    let totalPages = 1;

    // Farm names in Kurdish
    const farmNames = {
      1: 'فارمی یەکەم',
      2: 'فارمی دووەم',
      3: 'فارمی سێیەم',
      4: 'فارمی چوارەم'
    };

    // Load all farm data
    async function loadAllFarmsData() {
      try {
        const token = localStorage.getItem('token');

        const promises = [1, 2, 3, 4].map(farmNum =>
          fetch(`http://localhost:3000/farm${farmNum}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }).then(res => res.json())
        );

        const results = await Promise.all(promises);

        allRecords = [];
        results.forEach((result, index) => {
          const farmNumber = index + 1;
          if (result.records) {
            result.records.forEach(record => {
              allRecords.push({
                ...record,
                farmNumber: farmNumber,
                farmName: farmNames[farmNumber]
              });
            });
          }
        });

        filteredRecords = [...allRecords];
        currentPage = 1;
        displayRecords(filteredRecords);
        updateSummaryCards(filteredRecords);
        updateFarmSummaries(allRecords);

      } catch (error) {
        console.error('Error loading farms data:', error);
        alert('هەڵەیەک ڕوویدا لە بارکردنی داتاکان');
      }
    }

    // ✅ UPDATED: Display records with totalEggs
    function displayRecords(records) {
      const tbody = document.getElementById('calculationTableBody');
      const tfoot = document.getElementById('calculationTableFooter');

      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">هیچ داتایەک نییە</td></tr>';
        tfoot.style.display = 'none';
        updatePaginationInfo(0, 0, 0);
        return;
      }

      // Calculate pagination
      totalPages = Math.ceil(records.length / pageSize);
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, records.length);
      const paginatedRecords = records.slice(startIndex, endIndex);

      tbody.innerHTML = paginatedRecords.map((record, index) => `
        <tr class="farm-${record.farmNumber}-row">
          <td>${startIndex + index + 1}</td>
          <td><strong>${record.farmName}</strong></td>
          <td>${(record.packets || 0).toLocaleString()}</td>
          <td>${(record.flats || 0).toLocaleString()}</td>
          <td>${(record.eggs || 0).toLocaleString()}</td>
          <td><strong style="color: #0d6efd;">${(record.totalEggs || 0).toLocaleString()}</strong></td>
          <td>${new Date(record.createdAt).toLocaleDateString('en-GB')}</td>
          <td>${record.updatedAt ? new Date(record.updatedAt).toLocaleDateString('en-GB') : '-'}</td>
        </tr>
      `).join('');

      // ✅ UPDATED: Footer totals using totalEggs
      const totalPackets = records.reduce((sum, r) => sum + (r.packets || 0), 0);
      const totalFlats = records.reduce((sum, r) => sum + (r.flats || 0), 0);
      const totalEggsIndividual = records.reduce((sum, r) => sum + (r.eggs || 0), 0);
      const totalEggs = records.reduce((sum, r) => sum + (r.totalEggs || 0), 0);

      document.getElementById('footerTotalPackets').textContent = totalPackets.toLocaleString();
      document.getElementById('footerTotalFlats').textContent = totalFlats.toLocaleString();
      document.getElementById('footerTotalEggsIndividual').textContent = totalEggsIndividual.toLocaleString();
      document.getElementById('footerTotalEggs').textContent = totalEggs.toLocaleString();
      document.getElementById('footerTotalRecords').textContent = `${records.length}`;
      tfoot.style.display = 'table-footer-group';

      // Update pagination info
      updatePaginationInfo(startIndex + 1, endIndex, records.length);
    }

    // Update pagination info and buttons
    function updatePaginationInfo(from, to, total) {
      document.getElementById('showingFrom').textContent = from;
      document.getElementById('showingTo').textContent = to;
      document.getElementById('totalItems').textContent = total;
      document.getElementById('currentPage').textContent = currentPage;
      document.getElementById('totalPages').textContent = totalPages;

      // Enable/disable buttons
      document.getElementById('firstPageBtn').disabled = currentPage === 1;
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
      document.getElementById('lastPageBtn').disabled = currentPage === totalPages || totalPages === 0;
    }

    // Pagination functions
    function nextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        displayRecords(filteredRecords);
      }
    }

    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        displayRecords(filteredRecords);
      }
    }

    function goToFirstPage() {
      currentPage = 1;
      displayRecords(filteredRecords);
    }

    function goToLastPage() {
      currentPage = totalPages;
      displayRecords(filteredRecords);
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSize').value);
      currentPage = 1;
      displayRecords(filteredRecords);
    }

    // ✅ UPDATED: Summary cards using totalEggs
    function updateSummaryCards(records) {
      const totalEggs = records.reduce((sum, r) => sum + (r.totalEggs || 0), 0);
      const totalFlats = records.reduce((sum, r) => sum + (r.flats || 0), 0);
      const totalPackets = records.reduce((sum, r) => sum + (r.packets || 0), 0);

      document.getElementById('totalEggsCard').textContent = totalEggs.toLocaleString();
      document.getElementById('totalFlatsCard').textContent = totalFlats.toLocaleString();
      document.getElementById('totalPacketsCard').textContent = totalPackets.toLocaleString();
      document.getElementById('totalRecordsCard').textContent = records.length;
    }

    // ✅ UPDATED: Farm summaries using totalEggs
    function updateFarmSummaries(records) {
      for (let i = 1; i <= 4; i++) {
        const farmRecords = records.filter(r => r.farmNumber === i);
        const totalEggs = farmRecords.reduce((sum, r) => sum + (r.totalEggs || 0), 0);
        const totalFlats = farmRecords.reduce((sum, r) => sum + (r.flats || 0), 0);
        const totalPackets = farmRecords.reduce((sum, r) => sum + (r.packets || 0), 0);

        document.getElementById(`farm${i}Eggs`).textContent = totalEggs.toLocaleString();
        document.getElementById(`farm${i}Flats`).textContent = totalFlats.toLocaleString();
        document.getElementById(`farm${i}Packets`).textContent = totalPackets.toLocaleString();
        document.getElementById(`farm${i}Records`).textContent = farmRecords.length;
      }
    }

    // Apply quick filter
    function applyQuickFilter() {
      const quickFilter = document.getElementById('filterQuick').value;
      const year = parseInt(document.getElementById('filterYear').value) || new Date().getFullYear();

      if (!quickFilter) return;

      let fromDate, toDate;

      if (quickFilter === 'today') {
        fromDate = toDate = new Date();
      } else if (quickFilter === 'week') {
        toDate = new Date();
        fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - 7);
      } else if (quickFilter === 'month') {
        toDate = new Date();
        fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - 30);
      } else if (quickFilter.startsWith('month')) {
        const monthNum = parseInt(quickFilter.replace('month', ''));
        fromDate = new Date(year, monthNum - 1, 1);
        toDate = new Date(year, monthNum, 0);
      }

      if (fromDate && toDate) {
        document.getElementById('filterDateFrom').value = fromDate.toISOString().split('T')[0];
        document.getElementById('filterDateTo').value = toDate.toISOString().split('T')[0];
        applyFilters();
      }
    }

    // Apply all filters
    function applyFilters() {
      let filtered = [...allRecords];

      // Farm filter
      const farmFilter = document.getElementById('filterFarm').value;
      if (farmFilter) {
        filtered = filtered.filter(r => r.farmNumber === parseInt(farmFilter));
      }

      // Date range filter
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;
      if (dateFrom || dateTo) {
        filtered = filtered.filter(record => {
          const recordDate = new Date(record.createdAt);
          const from = dateFrom ? new Date(dateFrom) : new Date('1900-01-01');
          const to = dateTo ? new Date(dateTo) : new Date('2100-12-31');
          to.setHours(23, 59, 59, 999);
          return recordDate >= from && recordDate <= to;
        });
      }

      // Search filter
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      if (searchTerm) {
        filtered = filtered.filter(r =>
          (r.totalEggs || 0).toString().includes(searchTerm) ||
          (r.flats || 0).toString().includes(searchTerm) ||
          (r.packets || 0).toString().includes(searchTerm) ||
          r.farmName.includes(searchTerm)
        );
      }

      // Sort
      const sortBy = document.getElementById('sortBy').value;
      filtered = sortRecords(filtered, sortBy);

      filteredRecords = filtered;
      currentPage = 1;
      displayRecords(filtered);
      updateSummaryCards(filtered);
    }

    // ✅ UPDATED: Sort by totalEggs
    function sortRecords(records, sortBy) {
      const sorted = [...records];

      switch (sortBy) {
        case 'date-desc':
          return sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        case 'date-asc':
          return sorted.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
        case 'eggs-desc':
          return sorted.sort((a, b) => (b.totalEggs || 0) - (a.totalEggs || 0));
        case 'eggs-asc':
          return sorted.sort((a, b) => (a.totalEggs || 0) - (b.totalEggs || 0));
        case 'farm-asc':
          return sorted.sort((a, b) => a.farmNumber - b.farmNumber);
        default:
          return sorted;
      }
    }

    // Clear filters
    function clearFilters() {
      document.getElementById('filterFarm').value = '';
      document.getElementById('filterDateFrom').value = '';
      document.getElementById('filterDateTo').value = '';
      document.getElementById('filterQuick').value = '';
      document.getElementById('searchInput').value = '';
      document.getElementById('sortBy').value = 'date-desc';
      document.getElementById('filterYear').value = new Date().getFullYear();

      filteredRecords = [...allRecords];
      currentPage = 1;
      displayRecords(filteredRecords);
      updateSummaryCards(filteredRecords);
    }

    // ✅ UPDATED: Generate Receipt with totalEggs
    async function generateReceipt() {
      if (filteredRecords.length === 0) {
        alert('❌ هیچ داتایەک بۆ دروستکردنی وەسڵ نییە');
        return;
      }

      // Show loading message
      const loadingMsg = document.createElement('div');
      loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px 50px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:99999;text-align:center;';
      loadingMsg.innerHTML = '<div style="font-size:20px;font-weight:bold;color:#667eea;margin-bottom:10px;">چاوەڕێبە...</div><div style="color:#666;">وەسڵەکە دروست دەکرێت</div>';
      document.body.appendChild(loadingMsg);

      // Calculate totals using totalEggs
      const totalEggs = filteredRecords.reduce((sum, r) => sum + (r.totalEggs || 0), 0);
      const totalFlats = filteredRecords.reduce((sum, r) => sum + (r.flats || 0), 0);
      const totalPackets = filteredRecords.reduce((sum, r) => sum + (r.packets || 0), 0);

      // Get date range
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;
      let dateRangeText = 'هەموو تۆمارەکان';
      if (dateFrom && dateTo) {
        dateRangeText = `لە ${dateFrom} بۆ ${dateTo}`;
      } else if (dateFrom) {
        dateRangeText = `لە ${dateFrom}`;
      } else if (dateTo) {
        dateRangeText = `تا ${dateTo}`;
      }

      // Get selected farm info
      const farmFilter = document.getElementById('filterFarm').value;
      let farmInfo = 'هەموو فارمەکان';
      if (farmFilter) {
        farmInfo = farmNames[parseInt(farmFilter)];
      }

      // Build table rows
      let tableRows = '';
      filteredRecords.forEach((record, index) => {
        tableRows += `
          <tr>
            <td>${index + 1}</td>
            <td>${record.farmName}</td>
            <td>${new Date(record.createdAt).toLocaleDateString('en-GB')}</td>
            <td>${(record.packets || 0).toLocaleString()}</td>
            <td>${(record.flats || 0).toLocaleString()}</td>
            <td>${(record.eggs || 0).toLocaleString()}</td>
            <td><strong>${(record.totalEggs || 0).toLocaleString()} هێلکە </strong></td>
          </tr>
        `;
      });

      // Create receipt HTML
      const receiptHTML = `
        <div class="watermark">سەرژمێری</div>
        
        <div class="receipt-header">
          <h1>وەسڵی سەرژمێری گشتی</h1>
          <h2>${farmInfo} - کورتەی داخڵکردنی هێلکە</h2>
        </div>

        <div class="receipt-body">
          <div class="info-cards">
            <div class="info-card">
              <h3>زانیاری کۆمپانیا</h3>
              <p><strong>ناو:</strong> سەرژمێری هێلکە</p>
              <p><strong>وەسڵ لەلایەن:</strong> ${currentUser.firstname} ${currentUser.lastname}</p>
              <p><strong>بەروار:</strong> ${new Date().toLocaleDateString('en-GB')}</p>
              <p><strong>کات:</strong> ${new Date().toLocaleTimeString('en-GB')}</p>
            </div>

            <div class="info-card">
              <h3>زانیاری وەسڵ</h3>
              <p><strong>ژمارەی وەسڵ:</strong> #${Date.now().toString().slice(-8)}</p>
              <p><strong>ماوە:</strong> ${dateRangeText}</p>
              <p><strong>کۆی تۆمارەکان:</strong> ${filteredRecords.length}</p>
              <p><strong>فارم:</strong> ${farmInfo}</p>
            </div>
          </div>

          <div class="summary-section">
            <h3 class="summary-title">کورتەی داخڵکردن</h3>
            <div class="summary-cards">
              <div class="summary-card">
                <h4>کۆی هێلکە</h4>
                <p class="value">${totalEggs.toLocaleString()}</p>
              </div>
              <div class="summary-card">
                <h4>کۆی تەبەق</h4>
                <p class="value">${totalFlats.toLocaleString()}</p>
              </div>
              <div class="summary-card">
                <h4>کۆی کارتۆن</h4>
                <p class="value">${totalPackets.toLocaleString()}</p>
              </div>
            </div>
          </div>

          <div class="table-section">
            <h3 class="table-title">وردەکاری تۆمارەکان</h3>
            <table class="receipt-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>فارم</th>
                  <th>بەروار</th>
                  <th>کارتۆن</th>
                  <th>تەبەق</th>
                  <th>هێلکە</th>
                  <th>کۆی گشتی</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        </div>

        <div class="receipt-footer">
          <div class="footer-line"></div>
          <p style="font-size:11px;margin-top:10px;opacity:0.8;">دروستکراوە لە: ${new Date().toLocaleString('en-GB')} © Designed by: Ballen Baxtyar 2026</p>
        </div>
      `;

      // Insert HTML into container
      const container = document.getElementById('receiptContainer');
      container.innerHTML = receiptHTML;
      container.style.left = '0';

      // Wait for fonts and images to load
      await new Promise(resolve => setTimeout(resolve, 500));

      try {
        // Convert HTML to canvas with auto height
        const canvas = await html2canvas(container, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#f5f7fa',
          width: 794,
          windowWidth: 794
        });

        // Convert canvas to PDF with multiple pages support
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'px',
          format: 'a4',
          compress: true
        });

        const imgData = canvas.toDataURL('image/png', 1.0);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();

        const imgWidth = canvas.width;
        const imgHeight = canvas.height;

        // Calculate scaling
        const ratio = pdfWidth / imgWidth;
        const scaledHeight = imgHeight * ratio;

        let heightLeft = scaledHeight;
        let position = 0;

        // Add first page
        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, scaledHeight, '', 'FAST');
        heightLeft -= pdfHeight;

        // Add additional pages if content is longer
        while (heightLeft > 0) {
          position = heightLeft - scaledHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, scaledHeight, '', 'FAST');
          heightLeft -= pdfHeight;
        }

        // Hide container
        container.style.left = '-9999px';

        // Remove loading message
        document.body.removeChild(loadingMsg);

        // Open PDF in new tab
        const pdfBlob = pdf.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        window.open(pdfUrl, '_blank');

      } catch (error) {
        console.error('Error generating PDF:', error);
        document.body.removeChild(loadingMsg);
        container.style.left = '-9999px';
        alert('❌ هەڵەیەک ڕوویدا لە دروستکردنی وەسڵ: ' + error.message);
      }
    }

    // Real-time search
    document.getElementById('searchInput').addEventListener('input', () => {
      applyFilters();
    });

    // Real-time sort
    document.getElementById('sortBy').addEventListener('change', () => {
      applyFilters();
    });

    // Load data on page load
    loadAllFarmsData();
  </script>

</body>

</html>